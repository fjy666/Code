# 0x01 题意
请维护一个长度为 $n$ 的序列 $a$，有 $m$ 次操作。
- $1\ L\ R$ 表示翻转区间 $[L,R]$，
- $2\ L\ R\ k$ 表示查询区间 $[L,R]$ 的 $k$ 小值。

$\texttt{Data\ Range}:1\le n,m,\texttt{值域}\le2\times10^5$。   
$\texttt{Time\ Limit}: 2.5\rm sec$。
## 0x02 做法
我们有一个 $\mathcal{O}(n\sqrt{n}\log n)$ 的做法，$\mathcal{O}(n\sqrt{n}\log^2n)$ **是错的**。  
显然直接大力块状链表，设块长为 $\texttt{B}$，我们对于每块维护它排序后和原序（支持分裂）的数组。  
e.g. $[1,2,4,3]$ 则块内有俩数组：$[1,2,3,4]$ 和 $[1,2,4,3]$。

翻转我们把两边的散块直接分裂出来，这一步花 $\mathcal{O}(\tt B\log B)$ 的时间。  
然后直接翻转链表上的区间，$\mathcal{O}(\tt \dfrac{n}{B})$。  
所以总复杂度就是 $m\times(\dfrac{n}{\tt B}+\tt B\log B)$。  
再看查询，我们直接值域二分。 $m\log V(\tt B+\dfrac{n}{B}\log B)$。  
我们得到了一个废物。  
考虑优化这个废物。  
我们发现对于查询这个操作，不用每次都遍历那两个散块，而是直接把这两个块 $\rm Split$ 成一个整块。 复杂度下降至 $m(\tt B\log B+\log V\dfrac{n}{B}\log B)$，瓶颈在于分裂的 $\tt B\log B$。  
我们只能修改块内的储存方式了。  
一个块内维护什么呢？  
- 排序后的块（方便查询）
- 排序后的数 $a_i$ 是 **原块** 中的 $b_j$，$i\rightarrow j$。  

举个例子原数组 $[1,2,4,3]$，排序后为 $[1,2,3,4]$，排序过后下标为 $1$ 的数排序前下标为 $1$，排序后下标为 $2$ 的数排序前下标为 $2$，排序后下标为 $3$ 的数排序前下标为 $4$，……  
所以额外数组为 $[1,2,4,3]$。  
利用它我们可以支持 $\mathcal{O}(B)$ 快速分裂和合并（归并排序）。  
于是我们再看看翻转的复杂度：$m(B+\dfrac{n}{B})$ 和查询的复杂度：$m(\tt B+\dfrac{n}{B}\log B\log V)$，$B$ 取 $\sqrt{n}\log n$ 则总时间复杂度为 $m\sqrt{n}\log n$。 我们成功去掉了一只 $\log$。  

by fjy666.